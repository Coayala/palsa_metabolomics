---
title: "New analysis SIP Palsa"
author: "Christian Ayala"
date: "7/27/2022"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: '2'
    collapsed: false
    highlight: tango
    css: style.css
---

# Data Pre-processing

## 1. Setup

### Importing libraries

```{r libraries, message=FALSE, warning=FALSE}
library(png)
library(readxl)
library(ggpubr)
library(vegan)
library(rstatix)
library(factoextra)
library(pheatmap)
library(ComplexHeatmap)
library(patchwork)
library(ggforce)
library(ggtext)
library(mixOmics)
library(ZIR)
library(pathview)
library(UpSetR)
library(KEGGREST)
library(tidyverse)
library(dtwclust)
source('new_analysis/functions_cdis_exploration.R')
source('new_analysis/functions_cdis_norm_stats.R')
source('new_analysis/functions_cdis_diff.R')
source('new_analysis/functions_extra.R')
source('new_analysis/get_kegg_functions.R')
```

### Setting project folders

```{r}
#set path variables
project_dir <- 'new_analysis'

# Give a name for your project so the results are all grouped together in a directory with the same name
project_name <- 'palsa_7_25_22'
figures_dir <- file.path(project_dir, paste0(project_name, '_output_figures'))
tables_dir <- file.path(project_dir,  paste0(project_name, '_output_tables'))

# Create output directories
dir.create(figures_dir, showWarnings = FALSE)

dir.create(tables_dir, showWarnings = FALSE)
```

## 2. Loading data

#### LC-MS data

```{r import_data, message=FALSE}
# Import data tables
cd_results_file <- file.path(project_dir, 
                             '..', 
                             'data', 
                             'palsa_labeled_snt_3_int_2e6.xlsx')

cd_results_table <- read_xlsx(cd_results_file) %>%
  mutate(Name = ifelse(abs(`Annot. DeltaMass [ppm]`) > 5, NA, Name),
         Formula = ifelse(abs(`Annot. DeltaMass [ppm]`) > 5, NA, Formula)) %>% 
  arrange(desc(`Calc. MW`)) %>% 
  mutate(FeatureID = paste0('Feature',formatC(n():0001, 
                                              width = 4, 
                                              flag = '0'))) %>%
  select(FeatureID, Name, Formula, `Calc. MW`, 
         contains('Annotation source'), contains('Results'), 
         contains('Pathways'), 
         contains('Area:'), contains('Gap Status:'), 
         contains('Labeling Status:'), contains('Gap Fill Status:'),
         contains('Rel. Exchange')) %>% 
  rename_with(function(.x){
    y <- str_remove(.x, 'Saleska_') %>% 
      str_remove('_26Jan.*')
    return(y)
  }) %>% 
  # Differentiate between features that share the same name using "peak#" at the end of the name
  group_by(Name) %>% 
  add_count(Name) %>% 
  # Create variable with names for plotting (useful in following scripts)
  mutate(name4plot = case_when(is.na(Name) ~ FeatureID,
                               n == 1 ~ Name,
                               TRUE ~  paste0(Name, '-peak', n():1))) %>% 
  select(-n) %>% 
  ungroup()

# Import metadata and fix names
metadata_file <- file.path(project_dir, 
                           '..', 
                           'data', 
                           'metadata_palsa_labeled.csv')

metadata <- read_csv(metadata_file) %>%  
  rename(SampleID = `Sample Identifier`,
         sample_type = `Sample Type`) %>% 
  filter(type == 'peat_and_litter' | type == 'peat' | type == 'litter',
         !(time == 'T0' & type == 'peat')) %>% 
  mutate(sample_type = str_replace(sample_type, 'Sample', 'Unlabeled'),
         type = factor(type, levels = c('litter', 'peat_and_litter', 'peat')),
         time = factor(time, levels = c('T0', 'T1', 'T2', 'T3')))

table_file <- file.path(tables_dir, 'fixed_metadata.csv')
write_csv(metadata, table_file)
```

#### NMR data

```{r}
nmr_data_file <-  file.path(project_dir, 
                            '..', 
                            'data', 
                            'NMR_palsa_all.csv')

nmr_data <- read_csv(nmr_data_file) %>% 
  select(Compound, Weight, Formula, KEGG_ID, all_of(metadata$SampleID))

nmr_label_file <- file.path(project_dir, 
                            '..', 
                            'data', 
                            'NMR_palsa_labeled_ready.csv')

nmr_data_label <- read_csv(nmr_label_file)

```


## 3. Rearranging data and calculating indexes 

### Separating label information

```{r}
label_status <- cd_results_table %>% 
  select(FeatureID, 
         contains('Labeling Status:'), 
         contains('Rel. Exchange')) %>% 
  pivot_longer(!FeatureID, names_to = c('.value', 'SampleID'), 
               names_pattern = '(.*): (.*)')  %>% 
  mutate(label_nw = 
           case_when(`Labeling Status` == 'No warnings' & 
                       `Rel. Exchange [%]` > 0.5 ~ 'Labeled',
                     `Labeling Status` == 'Not detected' ~ 'Not_detected',
                     TRUE ~ 'Non_labeled'),
         label_irreg = 
           case_when((`Labeling Status` == 'No warnings' & 
                        `Rel. Exchange [%]` > 0.5) |
                       (`Labeling Status` == 'Irregular exchange' & 
                          `Rel. Exchange [%]` > 15) ~ 'Labeled',
                     `Labeling Status` == 'Not detected' ~ 'Not_detected',
                     TRUE ~ 'Non_labeled')) %>% 
  mutate(label_nw = factor(label_nw, 
                           levels = c('Not_detected', 
                                      'Non_labeled', 
                                      'Labeled')),
         label_irreg = factor(label_irreg, 
                              levels = c('Not_detected', 
                                         'Non_labeled', 
                                         'Labeled')))


table_file <- file.path(tables_dir, 'label_status.csv')
write_csv(label_status, table_file)
```

### Abundance and chemical data

```{r data, message=FALSE, warning=FALSE}

# Split formula column into elemental counts
cd_results_table <- separate_formula(cd_results_table)

# Calculate ratios and thermodynamic indices
cd_results_table <- calc_ratios_n_idxs(cd_results_table)

# Calculate classes
cd_results_table <- calc_classes(cd_results_table)

# Gather area under the curve (AUC) values per sample

compounds_table <- cd_results_table %>% 
  select(-contains('Gap Status:'), -contains('Labeling Status:'), -contains('Gap Fill Status:'),
         -contains('Rel. Exchange [%]:')) %>% 
  pivot_longer(contains('Area:'), names_to = 'SampleID', values_to = 'AUC') %>% 
  mutate(SampleID = str_remove(SampleID, 'Area: ')) %>% 
  filter(AUC > 0) %>% 
  right_join(metadata, by = 'SampleID') %>% 
  left_join(label_status, by = c('FeatureID', 'SampleID')) %>% 
  select(-`Labeling Status`, - `Rel. Exchange [%]`, -label_nw) %>% 
  mutate(Class = factor(Class, levels = c("Amino Sugar", "Carbohydrate", 
                                          "Condensed HC", "Lignin", "Lipid",
                                          "Protein", "Tannin", 
                                          "Unsaturated HC", "Other")))

comp_names <- compounds_table %>% 
  select(FeatureID, name4plot) %>% 
  distinct()

feature_annot_df <- compounds_table %>% 
  select(FeatureID, Class, GFE, DBE, NOSC, AI_mod) %>% 
  distinct()

# Save gap-filled table to be used in Statistical Analysis

table_file <- file.path(tables_dir, 'compounds_table_with_label.csv')
write_csv(compounds_table, table_file)

```

#### Setting colors for treatments for all file

```{r}
sample_type_col <- get_palette(palette = 'Dark2', 2)
names(sample_type_col) <- unique(metadata$sample_type)

time_col <- c('#20A39E', '#FFB86F', '#23001E', '#B3001B')
names(time_col) <- unique(levels(metadata$time))

type_col <- c("#56A3A6", "#F4442E", "#020122")
names(type_col) <- unique(levels(metadata$type))

class_col <- c('#d76a03', '#ec9f05', '#2e4057', '#7e3766', '#4b2107', '#36bfb6',
               '#697a21', '#98a725', 'black')
names(class_col) <- c("Amino Sugar", "Carbohydrate", "Condensed HC", "Lignin", "Lipid",
                      "Protein", "Tannin", "Unsaturated HC", "Other")
```

## 4. Checking which compounds are labeled

#### LC-MS

```{r}

label_plot <- label_status %>% 
  pivot_longer(contains('label_'), names_to = 'detection', 
               values_to = 'label_status') %>% 
  filter(detection == 'label_irreg',
         SampleID != 'Palsa_T0',
         label_status != 'Not_detected') %>%
  group_by(SampleID, detection) %>% 
  count(label_status) %>% 
  ggplot() +
  geom_col(aes(x = SampleID,
               y = n,
               fill = label_status)) +
  scale_fill_manual(values = c(Labeled = '#ffb639', 
                               Non_labeled = '#006889'
  )) +
  theme_bw() +
  scale_y_continuous(expand = c(0,1)) +
  labs(y = '# of Features',
       fill = "Label status",
       title = 'Number of features detected per sample',
       subtitle = 'LC-MS/MS') +
  theme(#axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(face = 'bold', hjust = 0.5),
    plot.subtitle = element_text(face = 'italic', hjust = 0.5),
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank())

label_plot

label_annot_bar <- label_status %>% 
  filter(SampleID != 'Palsa_T0') %>% 
  left_join(metadata, by = 'SampleID') %>% 
  ggplot() +
  scale_fill_manual(values = type_col) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  geom_tile(aes(x = SampleID, 
                y = 1,
                fill = type),
            color = 'white') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks = element_blank()) +
  labs(fill = 'Sample type')

label_annot_bar

label_plot_f <- label_plot / label_annot_bar + plot_layout(heights = c(20, 1),
                                                           guides = 'collect')
label_plot_f

figure_file <- file.path(figures_dir, 'label_status.png')
ggsave(figure_file, label_plot, dpi = 300)
```

```{r}
label_mat <- label_status %>% 
  pivot_longer(contains('label_'), names_to = 'detection', 
               values_to = 'label_status') %>% 
  filter(detection == 'label_irreg',
         SampleID != 'Palsa_T0',
         label_status != 'Not_detected') %>%
  select(FeatureID, SampleID, label_status) %>% 
  #mutate(label_status = ifelse(label_status == 'Non_labeled', 1, 2)) %>% 
  pivot_wider(names_from = 'SampleID', values_from = 'label_status') %>% 
  column_to_rownames(var = 'FeatureID') %>% 
  arrange(PNE)

label_mat <- label_mat[unique(compounds_table$FeatureID), metadata$SampleID]

l_status_col <- c(Labeled = '#ffb639', Non_labeled = '#006889')

l_htmp <- Heatmap(label_mat,
                  cluster_rows = TRUE,
                  cluster_columns = FALSE,
                  show_row_dend = FALSE,
                  show_row_names = FALSE,
                  col = l_status_col,
                  row_title = 'LC-MS/MS',
                  name = 'Label Status',
                  column_names_rot = 45,
                  column_names_centered = FALSE,
                  column_names_gp = gpar(fontsize = 10))

l_htmp
```


#### NMR

```{r}
is_label <- nmr_data_label %>% 
  pivot_longer(any_of(metadata$SampleID), names_to = 'SampleID', values_to = 'Conc') %>% 
  mutate(label_status = ifelse(Conc > 0, 'Labeled', 'Non_labeled')) %>% 
  select(Compound, SampleID, label_status)


nmr_data_l <- nmr_data %>% 
  pivot_longer(all_of(metadata$SampleID), names_to = 'SampleID', values_to = 'Conc') %>% 
  full_join(is_label, by = c('SampleID', 'Compound')) %>% 
  mutate(label_status = ifelse(is.na(label_status), 'Non_labeled', label_status))


nmr_label_plot <- nmr_data_l %>% 
  group_by(SampleID) %>% 
  count(label_status) %>% 
  mutate(label_status = factor(label_status, levels = c('Non_labeled', 'Labeled'))) %>% 
  ggplot() +
  geom_col(aes(x = SampleID,
               y = n,
               fill = label_status)) +
  scale_fill_manual(values = c(Labeled = '#ffb639', 
                               Non_labeled = '#006889'
  )) +
  theme_bw() +
  scale_y_continuous(expand = c(0,1)) +
  labs(y = '# of Features',
       fill = "Label status",
       title = 'Number of features detected per sample',
       subtitle = 'NMR') +
  theme(#axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(face = 'bold', hjust = 0.5),
    plot.subtitle = element_text(face = 'italic', hjust = 0.5),
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank())

nmr_label_plot

nmr_label_plot_f <- nmr_label_plot / label_annot_bar + plot_layout(heights = c(20, 1),
                                                                   guides = 'collect')

nmr_label_plot_f

features_plot_f <- ((label_plot / label_annot_bar) + plot_layout(heights = c(20, 1)) | 
                      (nmr_label_plot / label_annot_bar) + plot_layout(heights = c(20, 1))) +
  plot_layout(guides = 'collect')

features_plot_f

figure_file <- file.path(figures_dir, 'label_status_both.png')
ggsave(figure_file, features_plot_f, width = 10, dpi = 300)
```

```{r}
nmr_label_mat <- nmr_data_l %>% 
  select(Compound, SampleID, label_status) %>% 
  pivot_wider(names_from = 'SampleID', values_from = 'label_status') %>% 
  column_to_rownames(var = 'Compound') %>% 
  arrange(PNE)

nmr_label_mat <- nmr_label_mat[, metadata$SampleID]


nmr_l_htmp <- Heatmap(nmr_label_mat,
                      cluster_rows = TRUE,
                      cluster_columns = FALSE,
                      show_row_dend = FALSE,
                      show_row_names = FALSE,
                      col = l_status_col,
                      row_title = 'NMR',
                      name = 'Label Status')

nmr_l_htmp


l_htmp %v% nmr_l_htmp
```

```{r}
label_upset <- ifelse(label_mat == 'Labeled', 1, 0)
label_upset[is.na(label_upset)] <- 0



UpSetR::upset(as.data.frame(label_upset), nsets = 7, order.by = 'freq')
```




# Statistical Analysis

## 5. Normalizing data

Not detected compounds are going to be assigned an intensity of 0

```{r}
auc_matrix <- compounds_table %>% 
  select(FeatureID, SampleID, AUC) %>% 
  pivot_wider(names_from = 'SampleID', values_from = 'AUC') %>% 
  column_to_rownames(var = 'FeatureID')

auc_matrix[is.na(auc_matrix)] <- 0

```

Test normalization methods

```{r}

normalization_plot <- normalize_by_all(auc_matrix)
normalization_plot

```

Normalizing data

```{r}
norm_matrix <- mean.norm(auc_matrix, transform_data = TRUE)
nml <- pivot_longer(norm_matrix, everything(), names_to = 'SampleID', values_to = 'value')
```

## 6. Multivariate Analysis

### PERMANOVA

```{r warning=FALSE}

t_norm_matrix_all <- t(norm_matrix)
dm.method <- 'bray'
# distance matrix by Bray because relative abundance mode was selected
dm_all <- vegdist(t_norm_matrix_all, method=dm.method)

set.seed(456)
permanova <- adonis2(dm_all ~ type + time, 
                     data=metadata, 
                     permutations=999, 
                     method="bray",
                     by = 'terms')
permanova

table_file <- file.path(tables_dir, 'permanova.csv')
write_csv(rownames_to_column(permanova, var = ' '), table_file)
```

### NMDS

Calculating distance matrix

```{r}
t_norm_matrix <- t(norm_matrix[,3:20])
dm.method <- 'bray'
# distance matrix by Bray because relative abundance mode was selected
dm <- vegdist(t_norm_matrix, method=dm.method)
```

Performing NMDS analysis

```{r}
set.seed(123)
nmds <- metaMDS(dm,
                k = 2,
                maxit = 999,
                trymax = 500,
                wascores = TRUE)
stressplot(nmds)
```

Extracting NMDS scores and plotting

```{r}
nmds_scores <- as.data.frame(scores(nmds, display = 'sites')) %>%
  rownames_to_column(var = 'SampleID') %>% 
  left_join(metadata, by = 'SampleID')

ellipse_col <- rep(as.character(time_col[c(2:4)]), each = 2)

nmds_plot <- nmds_scores %>% 
  filter(type != 'litter') %>% 
  ggplot(aes(x = NMDS1,
             y = NMDS2,
             color = time)) +
  scale_color_manual(values = time_col[c(2:4)]) +
  geom_point(aes(shape = type),
             size = 4) +
  ggnewscale::new_scale_color() +
  geom_mark_ellipse(aes(color = time:type,
                        fill = time:type),
                    alpha = 0.1,
                    show.legend = FALSE) +
  scale_color_manual(values = ellipse_col) +
  scale_fill_manual(values = ellipse_col) +
  guides(fill = guide_legend(override.aes = list(shape = 21, color = NA))) +
  geom_richtext(label =  paste0('**stress =** ', round(nmds$stress, 4), '<br>',
                               '**Time:** *p-value* = ', permanova$`Pr(>F)`[1], '<br>',
                               '**Sample Type:** *p-value* = ', permanova$`Pr(>F)`[2]),
                x = -0.075,
                y = 0.06,
                hjust = 0,
                vjust = 1,
                size = 2) +
  labs(title = 'NMDS plot',
       color = 'Time',
       shape = 'Sample type') +
  theme_bw() +
  theme(plot.title = element_text(face = 'bold', hjust = 0.5))
nmds_plot

figure_file <- file.path(figures_dir, 'nmds_relative_abundance.png')
ggsave(figure_file, nmds_plot, dpi = 300)
```

### PCA

Calculating PCA eigenvalues and plotting scree plot

```{r}
pca <- prcomp(t_norm_matrix)
# Get eigenvalues
eigen <- get_eigenvalue(pca)

scree_plot <- fviz_eig(pca, addlabels = TRUE) +
  theme_bw() +
  theme(plot.title = element_text(face = 'bold', hjust = 0.5))
scree_plot 

figure_file <- file.path(figures_dir, 'screeplot.png')
ggsave(figure_file, scree_plot, dpi = 300)
```

Extracting PCA coordinates and plotting

```{r}
pca_coordinates <- as.data.frame(pca$x) %>% 
  rownames_to_column(var = 'SampleID') %>% 
  left_join(metadata, by ='SampleID') 

# Prepare axis labels for PCA

pc1 <- paste0('PC1 (', round(eigen$variance.percent[1], digits = 1), '%)')
pc2 <- paste0('PC2 (', round(eigen$variance.percent[2], digits = 1), '%)')

# Plot Individuals PCA

pca_plot <- pca_coordinates %>% 
  ggplot() +
  geom_point(aes(x = PC1,
                 y = PC2,
                 color = time,
                 shape = type),
             size = 4) +
  scale_color_manual(values = time_col) +
  guides(fill = guide_legend(override.aes = list(shape = 21, color = NA))) +
  labs(title = 'PCA plot',
       x = pc1,
       y = pc2) +
  theme_bw() +
  theme(plot.title = element_text(face = 'bold', hjust = 0.5))


pca_plot

figure_file <- file.path(figures_dir, 'PCA-plot.png')
ggsave(figure_file, pca_plot, dpi = 300)
```



### sPLS-DA

```{r}
metadata <- metadata %>% 
  arrange(type)
t_norm_matrix_all <- t_norm_matrix_all[metadata$SampleID,]


splsda_res <- splsda(t_norm_matrix_all, metadata$type, keepX = c(10, 2))
pls_da_plot <- plotIndiv(splsda_res, ind.names = FALSE, legend = TRUE, 
                         group = metadata$type, 
                         pch = metadata$time, col.per.group = type_col,
                         title = 'sPLS-DA')

pls_da_var <- plotVar(splsda_res, title = 'Features contributing to differences')

loadings <- plotLoadings(splsda_res, contrib = 'max', method = 'mean', border = TRUE,
                         title = 'Features contributing to Component 1',
                         plot = FALSE) %>% 
  rownames_to_column(var = 'FeatureID') %>% 
  left_join(feature_annot_df, by = 'FeatureID') %>% 
  mutate(Contributes = ifelse(Contrib.litter, 'litter', 'incubation')) %>% 
  ggplot(aes(x = importance,
             y = fct_reorder(FeatureID, abs(importance)),
             fill = Class)) +
  #scale_fill_manual(values = type_col[c(1,2)]) +
  geom_col(color = 'black') +
  labs(y = 'FeatureID',
       x = '<----Litter----   --Incubation-->') +
  scale_x_continuous(limits = c(-0.6, 0.6)) +
  theme_bw() +
  theme(plot.title = element_text(face = 'bold', hjust = 0.5))


loadings


```



## 7. Differential abundance analysis

### Sample-to-sample distances

This heatmap intends to provide an overview of sample similarities or
dissimilarities

```{r}
dist_samples <- dist(t_norm_matrix)
dist_matrix <- as.matrix(dist_samples)

metadata_filt <- metadata %>% 
  filter(type != 'litter')

hmp_annot_df <- metadata_filt %>% 
  select(SampleID, time) %>% 
  column_to_rownames(var = 'SampleID')

dist_matrix

hmp_annot_colors <- list(time = time_col,
                         sample_type = sample_type_col)

pheatmap(dist_matrix,
         clustering_distance_rows = dist_samples,
         clustering_distance_cols = dist_samples,
         annotation_col = hmp_annot_df,
         annotation_colors = hmp_annot_colors,
         color = colorRampPalette(rev(get_palette('Blues', 10)))(100))
```

### Getting samples lists

```{r}
treatments_df <- metadata %>% 
  dplyr::select(time, type) %>% 
  distinct %>% 
  unite(t_name, time, type, sep = '_', remove = FALSE) %>% 
  mutate(t_name = ifelse(type == 'litter', 'T0_litter', t_name))

sample_lists <- pmap(list(treatments_df$time,
                          treatments_df$type),
                     function(y, z){
                       
                       if(z == 'litter'){
                         metadata %>%
                           filter(type == z) %>% 
                           pull(SampleID)
                       } else {
                         metadata %>% 
                           filter(time == y,
                                  type == z) %>% 
                           pull(SampleID)
                       }
                       
                     })
names(sample_lists) <- treatments_df$t_name

samples_peat <- sample_lists[str_detect(names(sample_lists), 'peat$')]
samples_inc <- sample_lists[str_detect(names(sample_lists), 'peat_and_litter')]
```


### Calculate differential expression

Getting a list of labeled samples in each treatment

```{r}
label_lists <- purrr::map(sample_lists, function(x){
  unique(compounds_table %>% 
           filter(SampleID %in% x,
                  label_irreg == 'Labeled') %>% 
           pull(FeatureID))
})

label_inc <- label_lists[str_detect(names(label_lists), 'peat_and_litter')]
```

#### **Against peat at each time**

Differential expression will be calculated by comparing each time point
(labeled and unlabeled) with the peat at T1

```{r warning=FALSE, message=FALSE, results='hide'}

diff_exp_tables <- purrr::map2(samples_inc, samples_peat, function(x, y){
  diff <- get_diff_table(norm_matrix,
                         control.sample_list = y,
                         treatment.sample_list = x,
                         log2_transformed = TRUE) %>% 
    filter(!is.na(pval)) %>% 
    mutate(Expression = ifelse(log2FC > 0, 'Upregulated', 'Downregulated'))
  fdrtool_res <- fdrtool::fdrtool(diff$pval, statistic = 'pvalue', plot = FALSE)
  diff$fdrtool_pvalue <- fdrtool_res$pval
  diff$fdrtool_qval <- fdrtool_res$qval
  return(diff)
})

```

```{r}
ma_plots <- imap(diff_exp_tables, function(x, y){
  df <- x %>% 
    mutate(A = (control_means + treatment_means)/2,
           sig_color = case_when(fdrtool_qval < 0.05 & Expression == 'Upregulated' ~ 'Sig. upregulated',
                                 fdrtool_qval < 0.05 & Expression == 'Downregulated' ~ 'Sig. downregulated',
                                 TRUE ~ 'Non significant'))
  
  ma_plot <- ggplot(df) +
    geom_point(aes(x = A,
                   y = log2FC,
                   color = sig_color)) +
    scale_color_manual(values = c('Sig. upregulated' = 'indianred2',
                                  'Sig. downregulated' = 'blue2',
                                  'Non significant' = 'gray80')) +
    labs(x = 'Log2 mean expression',
         y = 'Log2 fold change',
         color = 'Differential abundance',
         title = y) +
    theme_bw()
})

agains_peat <- reduce(ma_plots, `|`) +
  plot_layout(guides = 'collect') +
  plot_annotation(title = 'Comparison against each time point peat') &
  theme(plot.title = element_text(face = 'bold', hjust = 0.5))


ggsave(file.path(figures_dir, 'ma_plots_peat.png'), agains_peat, dpi = 300, width = 8)

```

#### **Against peat T1**

Differential expression will be calculated by comparing each time point
(labeled and unlabeled) with the peat at T1

```{r warning=FALSE, message=FALSE, results='hide'}

diff_exp_tables <- purrr::map(samples_inc, function(x, y){
  diff <- get_diff_table(norm_matrix,
                         control.sample_list = samples_peat$T1_peat,
                         treatment.sample_list = x,
                         log2_transformed = TRUE) %>% 
    filter(!is.na(pval)) %>% 
    mutate(Expression = ifelse(log2FC > 0, 'Upregulated', 'Downregulated'))
  fdrtool_res <- fdrtool::fdrtool(diff$pval, statistic = 'pvalue', plot = FALSE)
  diff$fdrtool_pvalue <- fdrtool_res$pval
  diff$fdrtool_qval <- fdrtool_res$qval
  return(diff)
})

```

```{r}
ma_plots <- imap(diff_exp_tables, function(x, y){
  df <- x %>% 
    mutate(A = (control_means + treatment_means)/2,
           sig_color = case_when(fdrtool_qval < 0.05 & Expression == 'Upregulated' ~ 'Sig. upregulated',
                                 fdrtool_qval < 0.05 & Expression == 'Downregulated' ~ 'Sig. downregulated',
                                 TRUE ~ 'Non significant'))
  
  ma_plot <- ggplot(df) +
    geom_point(aes(x = A,
                   y = log2FC,
                   color = sig_color)) +
    scale_color_manual(values = c('Sig. upregulated' = 'indianred2',
                                  'Sig. downregulated' = 'blue2',
                                  'Non significant' = 'gray80')) +
    labs(x = 'Log2 mean expression',
         y = 'Log2 fold change',
         color = 'Differential abundance',
         title = y) +
    theme_bw()
})

agains_peat_t1 <- reduce(ma_plots, `|`) +
  plot_layout(guides = 'collect') +
  plot_annotation(title = 'Comparison against T1 peat') &
  theme(plot.title = element_text(face = 'bold', hjust = 0.5))


ggsave(file.path(figures_dir, 'ma_plots_peat_t1.png'), agains_peat_t1, dpi = 300, width = 8)

```


```{r}
volcanos <- imap(diff_exp_tables, function(x, y){
  plot_volcano(x, 
               log2FC,
               pval.adj,
               log2FC.threshold = 1,
               pval.threshold = 0.1,
               search_label = TRUE,
               label_ids_control = label_lists$T0_litter,
               label_ids_treatment = y) +
    labs(title = paste0(y, ' vs peat'))
})
```

:::: {.bisquebox data-latex=""}
Using the labeled and unlabeled samples together as replicates, helps to find statistically 
significant differences, that did not appeared before.
::::

```{r}

p_list <- volcanos

with_peat <- ggarrange(plotlist = volcanos, common.legend = TRUE, 
                       legend = 'bottom', nrow = 1)
with_peat

figure_file <- file.path(figures_dir, 'Comparisons_with_t1_peat.png')
ggsave(figure_file, with_t1_peat, dpi = 300, width = 12, bg = 'white')

```

```{r}
diff_exp_sig_labeled <- map2(diff_exp_tables, label_inc, function(x, y){
  
  comp_temp <- compounds_table %>% 
    select(FeatureID, Name, Formula, `Calc. MW`, Class) %>% 
    distinct()
  
  res <- x %>% 
    filter(pval.adj <= 0.1) %>% 
    mutate(label = case_when(
      (FeatureID %in% label_lists$T0_litter) & 
        (FeatureID %in% y) ~ 'Label in both',
      FeatureID %in% label_lists$T0_litter ~ 'Label in control',
      FeatureID %in% y ~ 'Label in treatment',
      TRUE ~ 'Unlabeled')) %>% 
    filter(label != 'Unlabeled') %>% 
    left_join(comp_temp, by = 'FeatureID')
})

iwalk(diff_exp_sig_labeled, function(x, y){
  filename <- file.path(tables_dir, paste0('Diff_df_', y, '_against_peat_T1.csv'))
  write_csv(x, filename)
})
```

```{r}
names <- names(diff_exp_sig_labeled)
plot_bar <- map2(diff_exp_sig_labeled, names, 
                 function(x, y){
                   x %>% 
                     mutate(Expression = factor(Expression, 
                                                levels = c('Upregulated', 'Downregulated'))) %>% 
                     group_by(Expression) %>% 
                     count(Class) %>% 
                     ggplot() +
                     geom_col(aes(x = Class,
                                  y = n,
                                  fill = Expression),
                              position = position_dodge()) +
                     labs(title = y) +
                     facet_grid(cols = vars(Expression), 
                                scales = 'free_x',
                                space = 'free_x') +
                     scale_fill_manual(values = get_palette('RdBu', 2)) +
                     theme_bw() +
                     theme(plot.title = element_text(face = 'bold', 
                                                     hjust = 0.5),
                           axis.text.x = element_text(angle = 45, 
                                                      hjust = 1))
                 })
```

```{r}
bars <- ggarrange(plotlist = plot_bar,
                  nrow = 1,
                  align = 'h',
                  common.legend = TRUE, 
                  legend = 'bottom')
bars

figure_file <- file.path(figures_dir, 'classes_with_t1_peat.png')
ggsave(figure_file, bars, dpi = 300, width = 8, bg = 'white')

```



#### **Against litter**

Differential expression will be calculated by comparing each time point
(labeled and unlabeled) with the peat at T1

```{r warning=FALSE, message=FALSE, results='hide'}

diff_exp_tables <- purrr::map(samples_inc, function(x){
  diff <- get_diff_table(norm_matrix,
                         control.sample_list = sample_lists$T0_litter,
                         treatment.sample_list = x,
                         log2_transformed = TRUE) %>% 
    filter(!is.na(pval)) %>% 
    mutate(Expression = ifelse(log2FC > 0, 'Upregulated', 'Downregulated'))
  fdrtool_res <- fdrtool::fdrtool(diff$pval, statistic = 'pvalue', plot = FALSE)
  diff$fdrtool_pvalue <- fdrtool_res$pval
  diff$fdrtool_qval <- fdrtool_res$qval
  return(diff)
})

```


```{r}
ma_plots <- imap(diff_exp_tables, function(x, y){
  df <- x %>% 
    mutate(A = (control_means + treatment_means)/2,
           sig_color = case_when(pval.adj < 0.1 & Expression == 'Upregulated' ~ 'Sig. upregulated',
                                 pval.adj < 0.1 & Expression == 'Downregulated' ~ 'Sig. downregulated',
                                 TRUE ~ 'Non significant'))
  
  ma_plot <- ggplot(df) +
    geom_point(aes(x = A,
                   y = log2FC,
                   color = sig_color)) +
    scale_color_manual(values = c('Sig. upregulated' = 'indianred2',
                                  'Sig. downregulated' = 'blue2',
                                  'Non significant' = 'gray80')) +
    labs(x = 'Log2 mean expression',
         y = 'Log2 fold change',
         color = 'Differential abundance',
         title = y) +
    theme_bw()
})

agains_litter <- reduce(ma_plots, `|`) +
  plot_layout(guides = 'collect') +
  plot_annotation(title = 'Comparison against litter') &
  theme(plot.title = element_text(face = 'bold', hjust = 0.5))

agains_litter

ggsave(file.path(figures_dir, 'ma_plots_litter.png'), agains_litter, dpi = 300, width = 8)

ma_dfs <- imap(diff_exp_tables, function(x, y){
  df <- x %>% 
    mutate(A = (control_means + treatment_means)/2,
           sig_color = case_when(pval.adj < 0.1 & Expression == 'Upregulated' ~ 'Sig. upregulated',
                                 pval.adj < 0.1 & Expression == 'Downregulated' ~ 'Sig. downregulated',
                                 TRUE ~ 'Non significant'),
           time = y)
})

ma_dfs_all <- do.call(rbind, ma_dfs)

ma_all <- ma_dfs_all %>% 
  mutate(time = str_remove(time, '_peat.*')) %>% 
  ggplot() +
    geom_point(aes(x = A,
                   y = log2FC,
                   color = sig_color)) +
    scale_color_manual(values = c('Sig. upregulated' = 'indianred2',
                                  'Sig. downregulated' = 'blue2',
                                  'Non significant' = 'gray80')) +
    labs(x = 'Log2 mean expression',
         y = 'Log2 fold change',
         color = 'Differential abundance') +
    theme_bw() +
  facet_grid(cols= vars(time)) +
  theme(strip.placement = 'outside')

ma_all

```

```{r}
volcanos <- pmap(list(diff_exp_tables, label_inc, names(label_inc)),
                 function(x, y, z){
                   plot_volcano(x, 
                                log2FC,
                                pval.adj,
                                log2FC.threshold = 1,
                                pval.threshold = 0.1,
                                search_label = TRUE,
                                label_ids_control = label_lists$T0_litter,
                                label_ids_treatment = y) +
                     labs(title = paste0(z, ' vs litter'))
                 })
```

```{r}

l_list <- volcanos
with_litter <- ggarrange(plotlist = volcanos, common.legend = TRUE, 
                         nrow = 1,
                         legend = 'bottom')
with_litter

figure_file <- file.path(figures_dir, 'Comparisons_with_litter_peat.png')
ggsave(figure_file, with_litter, dpi = 300, width = 12, bg = 'white')

```

```{r}
combined <- ggarrange(plotlist = c(p_list, l_list),
                      nrow = 2, ncol = 2,
                      common.legend = TRUE,
                      legend = 'bottom')

combined
```


Get table of significantly differentially expressed labeled compounds 
(*p-value* < 0.1)

```{r}
diff_exp_sig_labeled <- map2(diff_exp_tables, label_inc, function(x, y){
  
  comp_temp <- compounds_table %>% 
    select(FeatureID, Name, Formula, `Calc. MW`, Class, GFE, DBE, NOSC, AI_mod, H_to_C, O_to_C) %>% 
    distinct()
  
  res <- x %>% 
    filter(pval.adj < 0.1) %>% 
    mutate(label = case_when(
      (FeatureID %in% label_lists$T0_litter) & 
        (FeatureID %in% y) ~ 'Labeled in both',
      FeatureID %in% label_lists$T0_litter ~ 'Labeled in litter samples',
      FeatureID %in% y ~ 'Label in peat+litter samples',
      TRUE ~ 'Unlabeled')) %>% 
    left_join(comp_temp, by = 'FeatureID')
})



```

```{r}
names <- names(diff_exp_sig_labeled)
plot_bar_dfs <- map2(diff_exp_sig_labeled, names, 
                 function(x, y){
                   x %>% 
                     mutate(Expression = factor(Expression, 
                                                levels = c('Upregulated', 'Downregulated'))) %>% 
                     group_by(Expression, label) %>% 
                     count(Class) %>% 
                     mutate(n = ifelse(Expression == 'Upregulated', n, -n),
                            time = y) 
                 })
```

```{r}
bars <- do.call(rbind, plot_bar_dfs) %>% 
  mutate(time = str_remove(time, '_peat.*')) %>% 
  ggplot() +
  geom_col(aes(x = Class,
               y = n,
               fill = label),
           color = 'black') +
  labs(y = '<-- Downregulated   Upregulated -->') +
  scale_y_continuous(labels = abs, breaks = scales::pretty_breaks()) +
  scale_fill_manual(values = c(get_palette('Dark2', 3), 'gray')) +
  theme_bw() +
  facet_grid(cols = vars(time)) +
  theme(plot.title = element_text(face = 'bold', 
                                  hjust = 0.5),
        axis.text.x = element_text(angle = 45, 
                                   hjust = 1))

bars

```

#### Thermo index

```{r}

index_box <- map2(diff_exp_sig_labeled, names, function(x,y){
  
  stat_df <- x %>%
    filter(Class %in% c('Lignin', 'Lipid', 'Protein')) %>%
    group_by(Class) %>%
    wilcox_test(NOSC ~ Expression) %>%
    adjust_pvalue() %>%
    add_significance() %>%
    add_xy_position()
  
  plot <- x %>% 
    filter(Class %in% c('Lignin', 'Lipid', 'Protein')) %>%
    ggplot(aes(x = Expression,
               y = NOSC,
               color = Expression)) +
    geom_violin() +
    ggbeeswarm::geom_beeswarm() +
    geom_hline(yintercept = 0,
               linetype = 'dashed') +
    labs(title = y) +
    scale_color_manual(values = c('Upregulated' = 'steelblue', 'Downregulated' = 'indianred2')) +
    facet_wrap(~Class) +
    stat_pvalue_manual(data = stat_df,
                       label = 'p.adj.signif',
                       hide.ns = TRUE) +
    theme_bw() +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_blank())
  
  
  plot
})


box_plot <- reduce(index_box, `|`) +
  plot_layout(guides = 'collect')

ggsave(file.path(figures_dir, 'box_nosc.png'), dpi = 300, width = 10)
```


```{r}

class_data <- read_csv('data/compound_class_table.csv')

class_rect <-  geom_rect(data = class_data,
                         aes(xmin = OC_low,
                             xmax = OC_high,
                             ymin = HC_low,
                             ymax = HC_high,
                             color = Class),
                         fill = NA,
                         size = 0.8,
                         inherit.aes = FALSE, 
                         linetype = 'dashed') 

vk <- imap(diff_exp_tables, function(x, y){
  df <- x %>% 
    mutate(sig_color = case_when(pval.adj < 0.1 & Expression == 'Upregulated' ~ 'Sig. upregulated',
                                 pval.adj < 0.1 & Expression == 'Downregulated' ~ 'Sig. downregulated',
                                 TRUE ~ 'Non significant'))
  
  comp_temp <- compounds_table %>% 
    select(FeatureID, Name, Formula, `Calc. MW`, Class, GFE, DBE, NOSC, AI_mod, H_to_C, O_to_C) %>% 
    distinct()
  
  vk_plot <- df %>% 
    left_join(comp_temp, by = 'FeatureID') %>% 
    ggplot() +
    geom_point(aes(x = O_to_C,
                   y = H_to_C,
                   color = sig_color)) +
    scale_color_manual(values = c('Sig. upregulated' = 'indianred2',
                                  'Sig. downregulated' = 'blue2',
                                  'Non significant' = 'gray80')) +
    ggnewscale::new_scale_color() +
    class_rect +
    labs(x = 'O:C',
         y = 'H:C',
         color = 'Differential abundance',
         title = y) +
    theme_bw()
})

vk_plots <- reduce(vk, `/`) + 
  plot_layout(guides = 'collect')

vk_plots

ggsave(file.path(figures_dir, 'vk_plots.png'), vk_plots, dpi = 300, width = 8, height = 6)

```


```{r}
diversity_table <- tibble(SampleID = rownames(t_norm_matrix_all),
                          Shannon = diversity(t_norm_matrix_all, index = 'shannon'),
                          Gini_Simpson = diversity(t_norm_matrix_all, index = 'simpson'))


diversity_plot <- diversity_table %>% 
  pivot_longer(!SampleID, names_to = 'index', values_to = 'values') %>% 
  filter(index == 'Shannon') %>% 
  left_join(metadata, by = 'SampleID') %>% 
  ggplot() +
  geom_boxplot(aes(x = time,
                   y = values,
                   fill = type)) +
  scale_fill_manual(values = type_col) +
  #facet_wrap(~type, scales = 'free_x') +
  labs(title = 'Abundance-based Diversity') +
  theme_bw() +
  theme(plot.title = element_text(face = 'bold', hjust = 0.5))

diversity_plot

```



```{r}
ggplot(x,
       aes(x = log2FC,
           y = NOSC)) +
  geom_point() +
  geom_smooth(method = 'lm') +
  stat_regline_equation(aes(label = ..rr.label..))


```



#### UpsetR

```{r}
f_lists <- map(diff_exp_sig_labeled, function(x){
  features_up <- unique(x %>% 
                          filter(Expression == 'Upregulated') %>% 
                          pull(FeatureID))
  features_down <- unique(x %>% 
                            filter(Expression == 'Downregulated') %>% 
                            pull(FeatureID))
  
  res <- list(up = features_up,
              down = features_down)
})

f_lists <- unlist(f_lists, recursive = FALSE)

upset(fromList(f_lists), order.by = 'freq', nsets = 6)

```



#### Heatmap of normalized abundances

**Create color vector**

```{r}
htm_col <- circlize::colorRamp2(seq(0, 32, 4), 
                                viridis::inferno(9, 
                                                 direction = -1, 
                                                 begin = 0.2, 
                                                 end = 0.8))
```

**Create annotations**

```{r}
col_annot_df <- metadata %>% 
  select(SampleID, type, time) %>% 
  arrange(time) %>% 
  column_to_rownames(var = 'SampleID')

row_annot_df <- compounds_table %>% 
  select(FeatureID, NOSC, GFE, DBE, AI_mod, Class, `Calc. MW`) %>% 
  distinct() %>% 
  arrange(FeatureID) %>% 
  column_to_rownames(var = 'FeatureID')

ca1 <- columnAnnotation(df = col_annot_df,
                        col = list(type = type_col,
                                   time = time_col))

ra1 <- rowAnnotation(NOSC = anno_lines(row_annot_df$NOSC),
                     # GFE = anno_lines(row_annot_df$GFE),
                     # DBE = anno_lines(row_annot_df$DBE),
                     # AI = anno_lines(row_annot_df$AI_mod),
                     annotation_name_side = 'top')
ra2 <- rowAnnotation(df = select(row_annot_df, Class),
                     col = list(Class = class_col))
```



```{r}
norm_matrix_ord <- norm_matrix[rownames(label_mat), rownames(col_annot_df)]

ht <- Heatmap(norm_matrix_ord,
              col = htm_col,
              name = 'Normalized\nabundance',
              row_split = 4,
              column_split = 3,
              column_title = NULL,
              row_title = NULL,
              show_row_names = FALSE,
              top_annotation = ca1,
              left_annotation = ra1,
              #right_annotation = ra2,
              column_names_rot = 45,
              column_names_centered = FALSE,
              column_names_gp = gpar(fontsize = 10)
)

png('test.png', width = 3000, height = 2400, res = 300)
ht + l_htmp
dev.off()

ht_grob <- grid.grabExpr(draw(ht))
```

Extract features in dendrogram

```{r}
dendros <- row_dend(ht)
dendro_data <- ggdendro::dendro_data(dendros[[3]])

label_PNE <- label_mat %>% 
  select(PNE) %>% 
  rownames_to_column(var = 'FeatureID')

count_label_PNE <- label_PNE %>% 
  count(PNE)

names(dendros) <- paste0('dendro_', 1:4)

dendros_features <- map(dendros, function(x){
  dat <- ggdendro::dendro_data(x)
  
  temp <- compounds_table %>% 
    select(FeatureID, Name) %>% 
    distinct()
  
  label_mat2 <- label_mat %>% 
    select(PNC, PNE, contains('_E')) %>% 
    rownames_to_column(var = 'FeatureID')
  
  df <- dat$labels %>% 
    left_join(temp, by = c('label' = 'FeatureID')) %>% 
    left_join(label_mat2, by = c('label' = 'FeatureID')) 
})

dendros_features <- do.call(rbind, dendros_features) %>% 
  rownames_to_column(var = 'dendro') %>% 
  mutate(dendro = str_remove(dendro, '\\..*'))

features_accumulating <- dendro_data$labels %>% 
  left_join(label_PNE, by = c('label' = 'FeatureID')) %>% 
  count(PNE)

```





#### Molecular class of differentially abundant metabolites

```{r}
names <- names(diff_exp_sig_labeled)
plot_bar <- map2(diff_exp_sig_labeled, names, 
                 function(x, y){
                   x %>% 
                     mutate(Expression = factor(Expression, 
                                                levels = c('Upregulated', 'Downregulated'))) %>% 
                     group_by(Expression) %>% 
                     count(Class) %>% 
                     ggplot() +
                     geom_col(aes(x = Class,
                                  y = n,
                                  fill = Expression),
                              position = position_dodge()) +
                     labs(title = y) +
                     facet_grid(cols = vars(Expression), 
                                scales = 'free_x',
                                space = 'free_x') +
                     scale_fill_manual(values = get_palette('RdBu', 2)) +
                     theme_bw() +
                     theme(plot.title = element_text(face = 'bold', 
                                                     hjust = 0.5),
                           axis.text.x = element_text(angle = 45, 
                                                      hjust = 1))
                 })
```

```{r}
bars <- ggarrange(plotlist = plot_bar,
                  align = 'h',
                  nrow = 1,
                  common.legend = TRUE, 
                  legend = 'bottom')
bars

figure_file <- file.path(figures_dir, 'classes_with_litter.png')
ggsave(figure_file, bars, dpi = 300, width = 8, bg = 'white')

```

## 8. Individual figures

```{r}
norm_abundance_long <- norm_matrix %>% 
  rownames_to_column(var = 'FeatureID') %>% 
  pivot_longer(!FeatureID, names_to = 'SampleID', values_to = 'norm_abundance') %>% 
  filter(norm_abundance > 0) %>% 
  left_join(metadata, by = 'SampleID')

selected_features <- norm_abundance_long %>% 
  group_by(FeatureID, type, time) %>% 
  summarise(mean_norm = mean(norm_abundance)) %>% 
  mutate(type2 = ifelse(type == 'litter', 'incubation,peat', as.character(type))) %>% 
  separate_rows(type2, sep = ',') %>% 
  filter(FeatureID == 'Feature0219' |
           FeatureID == 'Feature0075')


plot_feature1 <- selected_features %>% 
  unite(group, type2, FeatureID, sep = '_', remove = FALSE) %>% 
  filter(type2 != 'peat',
         FeatureID == 'Feature0219') %>% 
  ggplot() +
  geom_line(aes(x = time,
                y = mean_norm,
                group = group,
                #color = FeatureID,
                linetype = type2),
            size = .8) +
  geom_point(aes(x = time,
                 y = mean_norm),
             size = 3) +
  annotate('rect',
           xmin = c(-Inf, 1.5),
           xmax = c(1.5, Inf),
           ymin = c(-Inf, -Inf),
           ymax = c(Inf, Inf),
           alpha = .2,
           fill = c('forestgreen', 'chocolate4')) +
  annotate('label', x = c(1, 4), y = c(16, 26), label = c('Litter', 'Incubation')) +
  labs(x = 'Time point',
       y = 'Mean normalized abundance',
       linetype = '') +
  theme_bw() +
  theme(legend.position = 'none')

plot_feature1

plot_feature2 <- selected_features %>% 
  unite(group, type2, FeatureID, sep = '_', remove = FALSE) %>% 
  filter(type2 != 'peat',
         FeatureID == 'Feature0075') %>% 
  ungroup() %>% 
  add_row(time = 'T0', mean_norm = NA, type2 = 'incubation') %>% 
  ggplot() +
  geom_line(aes(x = time,
                y = mean_norm,
                group = group,
                #color = FeatureID,
                linetype = type2),
            size = .8) +
  geom_point(aes(x = time,
                 y = mean_norm),
             size = 3) +
  annotate('rect',
           xmin = c(-Inf, 1.5),
           xmax = c(1.5, Inf),
           ymin = c(-Inf, -Inf),
           ymax = c(Inf, Inf),
           alpha = .2,
           fill = c('forestgreen', 'chocolate4')) +
  annotate('label', x = c(1, 4), y = c(23, 25), label = c('Litter', 'Incubation')) +
  labs(x = 'Time point',
       y = 'Mean normalized abundance',
       linetype = '') +
  theme_bw() +
  theme(legend.position = 'none')

plot_feature2


fig_track <- plot_feature1 / plot_feature2

ggsave(file.path(figures_dir, 'label_track.png'), fig_track, height = 10, width = 15, dpi = 300)

```

```{r}

sel_features_list <- plotLoadings(splsda_res, contrib = 'max', method = 'mean', plot = FALSE) %>% 
  rownames_to_column(var = 'FeatureID') %>% 
  pull(FeatureID)

selected_features <- norm_abundance_long %>% 
  group_by(FeatureID, type, time) %>% 
  summarise(mean_norm = mean(norm_abundance)) %>% 
  mutate(type2 = ifelse(type == 'litter', 'incubation,peat', as.character(type))) %>% 
  separate_rows(type2, sep = ',') %>% 
  filter(FeatureID %in% sel_features_list)


plot_features <- selected_features %>% 
  unite(group, type2, FeatureID, sep = '_', remove = FALSE) %>% 
  ggplot() +
  geom_line(aes(x = time,
                y = mean_norm,
                group = group,
                color = FeatureID,
                linetype = type2),
            size = .8) +
  geom_point(aes(x = time,
                 y = mean_norm),
             size = 3) +
  annotate('rect',
           xmin = c(-Inf, 1.5),
           xmax = c(1.5, Inf),
           ymin = c(-Inf, -Inf),
           ymax = c(Inf, Inf),
           alpha = .2,
           fill = c('forestgreen', 'chocolate4')) +
  annotate('label', x = c(1, 4), y = c(16, 26), label = c('Litter', 'Incubation')) +
  labs(x = 'Time point',
       y = 'Mean normalized abundance') +
  
  theme_bw()

plot_features

```

# Node table


```{r}
for_transf_lc <- compounds_table %>% 
  select(FeatureID, `Calc. MW`, SampleID, AUC) %>% 
  pivot_wider(names_from = 'SampleID', values_from = 'AUC') %>% 
  select(-FeatureID,
         Weight = `Calc. MW`)


for_transf_nmr <- read_csv(nmr_data_file) %>% 
  select(Weight, all_of(metadata$SampleID))


for_transf <- rbind(for_transf_lc, for_transf_nmr) %>% 
  mutate(all = 1)

write_csv(for_transf, file.path(tables_dir, 'data_transf.csv'))


node_table_lc <- compounds_table %>% 
  select(id = 'Calc. MW',
         name = "FeatureID") %>% 
  distinct() %>% 
  mutate(label_status = case_when(name %in% label_lists$T0_litter &
                                    name %in% label_inc_all ~ 'Label in litter and incubations',
                                  name %in% label_lists$T0_litter ~ 'Label only in litter',
                                  name %in% label_inc_all ~ 'Label only in incubation',
                                  TRUE ~ 'Unlabeled'),
         dataset = 'LC-MS/MS')

nmr_label <- nmr_label_mat %>% 
  select(PNE, contains('_E')) %>% 
  rownames_to_column(var = 'name') %>% 
  pivot_longer(!name, names_to = 'SampleID', values_to = 'value') %>% 
  filter(value != 'Non_labeled') %>% 
  group_by(name, value) %>% 
  summarise(where = paste(SampleID, collapse = ',')) %>% 
  mutate(label_status = case_when(where == 'PNE' ~ 'Label only in litter',
                                  str_detect(where, 'PNE') ~ 'Label in litter and incubations',
                                  TRUE ~ 'Label only in incubation')) %>% 
  select(name, label_status)


node_table_nmr <- nmr_data %>% 
  select(id = Weight,
         name = Compound) %>% 
  left_join(nmr_label, by = 'name') %>% 
  mutate(label_status = ifelse(is.na(label_status), 'Unlabeled', label_status),
         dataset = 'NMR')

node_table <- rbind(node_table_lc, node_table_nmr)

write_csv(node_table, file.path(tables_dir, 'node_table.csv'))

```

## 9. Dynamic time warping

```{r}


label_inc_all <- unique(reduce(label_inc, `c`))

label_status_color <- set_names(c(get_palette('Dark2', 3), 'gray'),
                                c('Label in litter and incubations',
                                  'Label only in incubation',
                                  'Label only in litter',
                                  'Unlabeled'))




data_dwt <- auc_matrix %>% 
  rownames_to_column(var = 'FeatureID') %>% 
  #filter(FeatureID %in% sig_features) %>% 
  pivot_longer(!FeatureID, names_to = 'SampleID', values_to = 'norm_abundance') %>% 
  left_join(metadata, by = 'SampleID') %>% 
  filter(type != 'peat') %>% 
  group_by(FeatureID, time) %>% 
  summarise(mean_norm_ab = mean(norm_abundance)) %>% 
  pivot_wider(names_from = time, values_from = mean_norm_ab) %>% 
  column_to_rownames(var = 'FeatureID')

dwt_res <- tsclust(data_dwt, 
                   type = 'h', 
                   k = 3,
                   preproc = zscore,
                   distance = 'sbd',
                   centroid = shape_extraction,
                   control = hierarchical_control(method = 'average'))

dwt_res@clusinfo


feature_dwt_plot3 <- plot_dwt_clusters(dwt_res, nrow = 3)

dwt_res <- tsclust(data_dwt, 
                   type = 'h', 
                   k = 4,
                   preproc = zscore,
                   distance = 'sbd',
                   centroid = shape_extraction,
                   control = hierarchical_control(method = 'average'))

dwt_res@clusinfo

feature_dwt_plot4 <- plot_dwt_clusters(dwt_res)

(feature_dwt_plot3 | feature_dwt_plot4) +
  plot_layout(guides = 'collect') +
  plot_annotation(tag_levels = list(c('3 clusters', '4 clusters')))

```

```{r}
sig_features <- do.call(rbind, diff_exp_sig_labeled) %>% 
  pull(FeatureID)

sig_features <- unique(sig_features)

data_dwt_sig <- auc_matrix %>% 
  rownames_to_column(var = 'FeatureID') %>% 
  filter(FeatureID %in% sig_features) %>% 
  pivot_longer(!FeatureID, names_to = 'SampleID', values_to = 'norm_abundance') %>% 
  left_join(metadata, by = 'SampleID') %>% 
  filter(type != 'peat') %>% 
  group_by(FeatureID, time) %>% 
  summarise(mean_norm_ab = mean(norm_abundance)) %>% 
  pivot_wider(names_from = time, values_from = mean_norm_ab) %>% 
  column_to_rownames(var = 'FeatureID')

dwt_res <- tsclust(data_dwt_sig, 
                   type = 'h', 
                   k = 3,
                   preproc = zscore,
                   distance = 'sbd',
                   centroid = shape_extraction,
                   control = hierarchical_control(method = 'average'))

dwt_res@clusinfo

feature_dwt_plot_sig <- plot_dwt_clusters(dwt_res, nrow = 3)
feature_dwt_plot_sig

```

```{r}

splsda_res <- splsda(t_norm_matrix_all, metadata$type, keepX = c(30, 2))
loading_features <- plotLoadings(splsda_res, contrib = 'max', method = 'mean', border = TRUE,
                                 title = 'Features contributing to Component 1',
                                 plot = FALSE) %>% 
  rownames_to_column(var = 'FeatureID') %>% 
  pull(FeatureID)


data_dwt_sig <- auc_matrix %>% 
  rownames_to_column(var = 'FeatureID') %>% 
  filter(FeatureID %in% loading_features) %>% 
  pivot_longer(!FeatureID, names_to = 'SampleID', values_to = 'norm_abundance') %>% 
  left_join(metadata, by = 'SampleID') %>% 
  filter(type != 'peat') %>% 
  group_by(FeatureID, time) %>% 
  summarise(mean_norm_ab = mean(norm_abundance)) %>% 
  pivot_wider(names_from = time, values_from = mean_norm_ab) %>% 
  column_to_rownames(var = 'FeatureID')

dwt_res <- tsclust(data_dwt_sig, 
                   type = 'h', 
                   k = 3,
                   preproc = zscore,
                   distance = 'sbd',
                   centroid = shape_extraction,
                   control = hierarchical_control(method = 'average'))

dwt_res@clusinfo

feature_dwt_plot_sig <- plot_dwt_clusters(dwt_res, nrow = 3)
feature_dwt_plot_sig


# loadings_30 <- plotLoadings(splsda_res, contrib = 'max', method = 'mean', border = TRUE,
#                          title = 'Features contributing to Component 1',
#                          plot = FALSE) %>% 
#   rownames_to_column(var = 'FeatureID') %>% 
#   left_join(feature_annot_df, by = 'FeatureID') %>% 
#   mutate(Contributes = ifelse(Contrib.litter, 'litter', 'incubation')) %>% 
#   ggplot(aes(x = importance,
#              y = fct_reorder(FeatureID, abs(importance)),
#              fill = Class)) +
#   #scale_fill_manual(values = type_col[c(1,2)]) +
#   geom_col(color = 'black') +
#   labs(y = 'FeatureID',
#        x = '<----Litter----   --Incubation-->') +
#   scale_x_continuous(limits = c(-0.6, 0.6)) +
#   theme_bw() +
#   theme(plot.title = element_text(face = 'bold', hjust = 0.5))
# 
# loadings_30

```

```{r}

data_dwt_lists <- auc_matrix %>% 
  rownames_to_column(var = 'FeatureID') %>% 
  filter(FeatureID %in% sig_features) %>% 
  pivot_longer(!FeatureID, names_to = 'SampleID', values_to = 'norm_abundance') %>% 
  left_join(metadata, by = 'SampleID') %>% 
  mutate(label_status = case_when(FeatureID %in% label_lists$T0_litter &
                                    FeatureID %in% label_inc_all ~ 'Label in litter and incubations',
                                  FeatureID %in% label_lists$T0_litter ~ 'Label only in litter',
                                  FeatureID %in% label_inc_all ~ 'Label only in incubation',
                                  TRUE ~ 'Unlabeled')) %>% 
  split(.$label_status)


data_dwt_label <- map(data_dwt_lists, function(x){
  
  df <- x %>% filter(type != 'peat') %>% 
    group_by(FeatureID, time) %>% 
    summarise(mean_norm_ab = mean(norm_abundance)) %>% 
    pivot_wider(names_from = time, values_from = mean_norm_ab) %>% 
    column_to_rownames(var = 'FeatureID')
  
  dwt_res <- tsclust(df, 
                     type = 'h', 
                     k = 4,
                     preproc = zscore,
                     distance = 'sbd',
                     centroid = shape_extraction,
                     control = hierarchical_control(method = 'average'))
  
  dwt_res@clusinfo
  
  feature_dwt_plot_sig <- plot_dwt_clusters(dwt_res, nrow = 2)
  
})

((data_dwt_label[[1]] | data_dwt_label[[2]]) /
  (data_dwt_label[[3]] | data_dwt_label[[4]])) +
  plot_layout(guides = 'collect')

```


### Classes of metabolites from Dwt

```{r}

clust_annot <- feature_dwt_clusts %>% 
  select(cluster, FeatureID, label_status) %>% 
  distinct() %>% 
  left_join(feature_annot_df, by = 'FeatureID')


clust_mol_class <- clust_annot %>% 
  group_by(cluster, label_status) %>% 
  count(Class) %>% 
  ggplot() +
  geom_col(aes(x = Class,
               y = n,
               fill = label_status)) + 
  scale_fill_manual(values = c(get_palette('Set1', 3), 'gray')) +
  theme_bw() +
  facet_wrap(~cluster, nrow = 3) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

clust_mol_class

stat_nosc <- clust_annot %>% 
  filter(!(Class %in% c('Tannin', 'Unsaturated HC', 'Other'))) %>% 
  group_by(Class) %>% 
  wilcox_test(NOSC ~ cluster) %>% 
  add_xy_position()


clust_nosc <- clust_annot %>% 
  filter(!(Class %in% c('Tannin', 'Unsaturated HC', 'Other'))) %>% 
  ggplot(aes(x = cluster,
             y = NOSC)) +
  #geom_violin() +
  geom_boxplot(color = 'black') +
  geom_hline(yintercept = 0,
             linetype = 'dashed',
             color = 'indianred2') +
  scale_color_manual(values = c(get_palette('Set1', 3), 'gray')) +
  theme_bw() +
  stat_pvalue_manual(data = stat_nosc,
                     label = 'p.adj.signif',
                     hide.ns = TRUE) +
  facet_wrap(~Class, nrow = 3) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


clust_nosc

clust_fig <- ((feature_dwt_plot + theme(legend.position = 'none')) | clust_mol_class | clust_nosc) + 
  plot_layout(guides = 'collect')

ggsave(file.path(figures_dir, 'dwtclust_fig.png'), clust_fig, dpi = 300, width = 15, height = 8)

```


For peat

```{r}
data_dwt_peat <- auc_matrix %>% 
  rownames_to_column(var = 'FeatureID') %>% 
  pivot_longer(!FeatureID, names_to = 'SampleID', values_to = 'norm_abundance') %>% 
  left_join(metadata, by = 'SampleID') %>% 
  filter(type == 'peat') %>% 
  group_by(FeatureID, time) %>% 
  summarise(mean_norm_ab = mean(norm_abundance)) %>% 
  pivot_wider(names_from = time, values_from = mean_norm_ab) %>% 
  column_to_rownames(var = 'FeatureID')

data_dwt_peat <- data_dwt_peat[rowSums(data_dwt_peat) > 0,]

dwt_res_peat <- tsclust(data_dwt_peat, 
                        type = 'h', 
                        k = 3,
                        preproc = zscore,
                        distance = 'sbd',
                        centroid = shape_extraction,
                        control = hierarchical_control(method = 'average'))


plot(dwt_res_peat)
x <- plot(dwt_res_peat, type = 'sc', plot = FALSE) +
  scale_x_continuous(labels = c('T1', 'T2', 'T3'), breaks = 1:3) +
  labs(title = 'Dynamic Time Warping of Features') +
  theme(plot.title = element_text(face = 'bold', hjust = 0.5)) +
  facet_wrap(~cl, nrow = 3)

x
```

```{r}
class_all <- compounds_table %>% 
  group_by(SampleID) %>% 
  count(Class) %>% 
  ggplot(aes(x = SampleID,
             y = n,
             fill = Class)) +
  geom_col(color = 'black') +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

class_all


```


```{r}
diff_lists_up <- map(diff_exp_sig_labeled, function(x){
  x %>% 
    filter(Expression == 'Upregulated') %>% 
    pull(FeatureID)
})

diff_lists_down <- map(diff_exp_sig_labeled, function(x){
  x %>% 
    filter(Expression == 'Downregulated') %>% 
    pull(FeatureID)
})

ggvenn::ggvenn(diff_lists_up)
ggvenn::ggvenn(diff_lists_down)

```

# 10. Final figures

### Figure 1

# Loading external figure

```{r}
label_img <- readPNG(file.path(figures_dir, 'label_features_ID.png'), native = TRUE)
```


# Joining figures

```{r}
fig1 <- (((label_plot / label_annot_bar) + 
            plot_layout(heights = c(20, 1),
                        guides = 'collect')) |                
  wrap_elements(full = label_img,
                clip = FALSE)) +
  plot_layout(widths = c(1, 3)) +
  plot_annotation(tag_levels = list(c('A', '', 'B')))

fig1                                                       

figure_file <- file.path(figures_dir, 'final_figures', 'Figure_1.png')
ggsave(figure_file, fig1, dpi = 300, height = 5, width = 15)
```

### Figure 2

```{r}

figure_2 <- wrap_elements(full = ht_grob, clip = FALSE) + nmds_plot +
  plot_layout(widths = c(2.5, 1.2)) +
  plot_annotation(tag_levels = 'A') &
  theme(plot.tag = element_text(size = 20))

figure_2

figure_file <- file.path(figures_dir, 'final_figures', 'Figure2.png')
ggsave(figure_file, figure_2, dpi = 300, width = 12, height = 6,  bg = 'white')

```

### Figure 3

```{r}
figure_3 <- ma_all / bars

figure_3

figure_file <- file.path(figures_dir, 'final_figures', 'Figure3.png')
ggsave(figure_file, figure_3, dpi = 300, width = 8, height = 8,  bg = 'white')


```


### Figure 4

```{r}
figure_4 <- pls_da_plot$graph + loadings +
  plot_annotation(tag_levels = 'A') &
  theme(plot.tag = element_text(size = 20))

figure_4

figure_file <- file.path(figures_dir, 'final_figures', 'Figure4.png')
ggsave(figure_file, figure_4, dpi = 300, width = 10)
```

### Figure 5

```{r}
figure_5 <- feature_dwt_plot_sig

figure_file <- file.path(figures_dir, 'final_figures', 'Figure5.png')
ggsave(figure_file, figure_5, dpi = 300, width = 8)

```


